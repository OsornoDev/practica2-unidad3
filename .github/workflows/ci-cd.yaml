name: CI-CD K3S Easy Mode

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Install k3s
      run: |
        curl -sfL https://get.k3s.io | sh -
        mkdir -p ~/.kube
        sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
        sudo chown $USER:$USER ~/.kube/config
        echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV

    - name: Create namespace
      run: kubectl apply -f k8s/namespace.yaml

    - name: Build Docker image
      run: docker build -t demo-app:latest ./app

    - name: Load image into k3s
      run: |
        docker save demo-app:latest -o image.tar
        sudo k3s ctr images import image.tar

    - name: Deploy to k3s
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/ingress.yaml

    - name: Run release tests
      run: bash release-env/run-tests.sh

    - name: Check metrics (rollback)
      run: |
        RESULT=$(bash metrics/simulate-metrics.sh | tail -1)
        if [ "$RESULT" = "UNHEALTHY" ]; then
          echo "Rollback activado por m√©tricas"

          # Comprobar si existe historial de rollouts
          if kubectl rollout history deployment/demo-app -n production | grep -q "deployment.apps/demo-app"; then
            echo "Ejecutando rollback..."
            kubectl rollout undo deployment/demo-app -n production
          else
            echo "No hay historial de rollouts. Se omite rollback."
          fi

          exit 1
        fi


    - name: SUCCESS
      run: echo "Despliegue completado correctamente."
